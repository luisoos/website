---
import ThemeToggle from '../components/ThemeToggle.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import Layout from '../layouts/Layout.astro';
import Repositories from '../components/Repositories.astro';
import { Highlighter } from '../components/ui/highlighter';
import FormattedDate from '../components/FormattedDate.astro';
import { getCollection } from 'astro:content';
import { ReactIcon } from '../components/ui/icon';
import TechStack from '../components/tech-stack';
import { getPinnedRepos, type PinnedRepo, type GithubUser } from 'github-pinned-repo-sdk';
import Navbar from '../components/Navbar';

// Fetch latest 3 blog posts
const blogPosts = await getCollection('blog');
const latestBlogPosts: { title: string; url: string; date: Date }[] = blogPosts
    .sort(
        (a, b) =>
            new Date(b.data.pubDate).getTime() -
            new Date(a.data.pubDate).getTime(),
    )
    .slice(0, 3)
    .map((post) => ({
        title: post.data.title,
        url: `/blog/${post.id}`,
        date: post.data.pubDate,
    }));

// Fetch GitHub user data and pinned repositories
const githubUserName = 'luisoos';
const { user: githubUser, pinned_repos: repositories } = await getPinnedRepos(githubUserName);
---

<Layout title={SITE_TITLE} description={SITE_DESCRIPTION}>
    <div class='min-h-screen'>
        <Navbar />
        <div class='my-16 mx-auto max-w-3xl px-5'>
            <div class='w-full mb-4 flex items-start justify-between'>
                <div>
                    <h1 class='text-3xl md:text-4xl pt-2 pb-1 font-bold'>
                        Hi, I'm {
                            githubUser.avatar_url && (
                                <img
                                    src={githubUser.avatar_url}
                                    alt=''
                                    class='inline w-8 h-8 mb-1 rounded-4xl mr-2 sm:ml-4'
                                />
                            )
                        }Luis.
                    </h1>
                    <p class='opacity-80'>
                        <span>Fullstack Software Engineer & University student based
                        in</span> <img
                            src='https://animated-country-flags.malith.dev/webp/DE.webp'
                            alt='ðŸ‡©ðŸ‡ª'
                            class='inline w-6 h-6 ml-1'
                        />
                    </p>
                    <a
                        href={`https://github.com/${githubUserName}`}
                        class='flex ml-0.5 opacity-40 hover:opacity-80 transition-opacity duration-500'>
                        <ReactIcon
                            name='github'
                            size={16}
                            className='my-auto mr-2'
                        /> @{githubUserName}
                    </a>
                </div>
                <div class='my-auto ml-auto'>
                    <ThemeToggle />
                </div>
            </div>
            <h2 class='text-2xl font-semibold mt-16'>
                Building secure & high-quality software
            </h2>
            <p class='opacity-80'>
                Fullstack developer with
                <Highlighter client:load action='underline' color='#fce46c'>
                    5+ years crafting intuitive user experiences
                </Highlighter>
                with a strong focus on privacy and performance. Check out my latest
                blog posts â€” reflecting my personal opinions on new technology or
                serving as informational pieces â€” and explore my pinned repositories
                below.
            </p>

            <h2 class='text-xl font-semibold mb-2 mt-12'>Recent Blog Posts</h2>
            <ul class='opacity-80 list-disc pl-5'>
                {
                    latestBlogPosts.map((post) => (
                        <li class='mb-1'>
                            <a href={post.url} class='text-blue-600'>
                                {post.title}
                                <span class='pl-2 opacity-40 no-underline'>
                                    <FormattedDate date={post.date} />
                                </span>
                            </a>
                        </li>
                    ))
                }
            </ul>
            <a
                href='/blog'
                class='mt-2 group inline-flex items-center gap-1 opacity-40 hover:opacity-100 transition-opacity'>
                <span>View all blog posts</span>
                <svg
                    xmlns='http://www.w3.org/2000/svg'
                    width='16'
                    height='16'
                    viewBox='0 0 24 24'
                    fill='none'
                    stroke='currentColor'
                    stroke-width='2'
                    stroke-linecap='round'
                    stroke-linejoin='round'
                    class='transition-transform duration-200 group-hover:translate-x-1'>
                    <path d='M5 12h14'></path>
                    <path d='m12 5 7 7-7 7'></path>
                </svg>
            </a>

            <h2 class='text-xl font-semibold mb-4 mt-18'>
                Pinned Repositories
            </h2>
            <div
                class='repositories w-full grid grid-cols-1 sm:grid-cols-2 grid-rows-2 md:grid-rows-1 mb-12 gap-4'>
                <Repositories repositories={repositories.map((apiRepo) => ({
                    ...apiRepo,
                    author: apiRepo.owner,
                    name:   apiRepo.repo,
                    link:          apiRepo.link || "", 
                    description:   apiRepo.description || "Keine Beschreibung",
                    language:      apiRepo.language || "N/A",
                    languageColor: apiRepo.languageColor || "#ccc",
                    stars:         apiRepo.stars ?? 0,
                    forks:         apiRepo.forks ?? 0,
                }))} />
            </div>

            <h2 class='text-xl font-semibold mt-18'>Tech Stack</h2>
            <p class='opacity-80'>
                Tools & Technologies I am proficient in. Hover over any icon to
                discover projects where I've applied these skills.
            </p>
            <div
                class='grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-2'>
                <TechStack client:load />
            </div>
        </div>
    </div>
</Layout>
